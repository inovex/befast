language: node_js
node_js:
  - "node"
cache:
  directories:
    - "node_modules" # This will tell Travis CI to cache the dependencies

before_script:
  - pwd
  - cd blazingly-fast-blog/ # change dir to project
  - yarn # install dependencies
  - yarn build # build project
  - yarn test # run performance prechecks


script: 
  - NOW_URL="$(now --public -e NODE_ENV=production --token $NOW_TOKEN --yarn)" # deploy to now
  # store deployment url from clipboard into the deployment url 
  - echo $NOW_URL

after_success: 
  # https://graysonkoonce.com/getting-the-current-branch-name-during-a-pull-request-in-travis-ci/
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
  - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, PR=$PR, BRANCH=$BRANCH"
  # alias url only when deploying master branch
  - if [ $BRANCH = master ]; then npm run alias; fi
 # - $BRANCH=master && npm run alias 
  - npm run lh $NOW_URL
  - TEST_URL=$NOW_URL GIT_TOKEN=$GIT_TOKEN WEBPAGETEST_API_KEY=$WEBPAGETEST_API_KEY node webPageTest.js
